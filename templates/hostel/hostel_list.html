{% extends 'base.html' %}
{% load static %}
{% block title %}Hostel List{% endblock %}

{% block content %}
<style>
  /* ====== Your Existing Styles (unchanged) ====== */
  html, body { height: 100%; }
  body { background: transparent !important; }
  body::before{
    content:"";
    position: fixed; inset: 0;
    background: url("{% static 'images/bg-wave.png' %}") center/cover no-repeat fixed;
    z-index: -1;
  }
  .edge-to-edge{ width:100vw; position:relative; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw; }
  .page-wrap{
    width:100%;
    background: rgba(255,255,255,.70);
    border:1px solid rgba(233,213,255,.55);
    border-radius:12px;
    padding:18px 22px;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    box-shadow:0 8px 24px rgba(0,0,0,.08);
  }
  .page-title{ font-weight:800; font-size:1.9rem; display:flex; align-items:center; gap:.6rem; margin-bottom:.6rem; }
  .toolbar{ display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:.75rem; margin-bottom:1rem; }

  .btnx{ display:inline-block; padding:.44rem .9rem; border-radius:999px; font-weight:700; text-decoration:none!important; transition:.18s; border:1px solid transparent; }
  .btnx:focus{ outline:none; box-shadow:0 0 0 .18rem rgba(124,58,237,.18); }
  .btn-primaryx{ background:linear-gradient(135deg,#a78bfa,#7c3aed); color:#fff; border:0; box-shadow:0 10px 22px rgba(124,58,237,.25); }
  .btn-primaryx:hover{ background:#5b21b6; color:#fff; transform:translateY(-1px); }
  .btn-outlinex{ background:#fff; border:1px solid rgba(233,213,255,.75); color:#3b3b3b; }
  .btn-outlinex:hover{ background:#6d28d9; color:#fff; border-color:#6d28d9; }
  .btn-editx{ background:#fff; border:1px solid #fbbf24; color:#b45309; padding:.28rem .7rem; font-size:.92rem; }
  .btn-editx:hover{ background:#b45309; color:#fff; border-color:#b45309; }
  .btn-delex{ background:#fff; border:1px solid #fca5a5; color:#b91c1c; padding:.28rem .7rem; font-size:.92rem; cursor:pointer; }
  .btn-delex:hover{ background:#b91c1c; color:#fff; border-color:#b91c1c; }

  .search-input{ border:1px solid rgba(233,213,255,.75); border-radius:999px; padding:.5rem 1rem; min-width:320px; background:rgba(255,255,255,.9); }
  .search-input:focus{ border-color:#8b5cf6; box-shadow:0 0 0 .18rem rgba(139,92,246,.18); outline:none; }

  .table-wrap{ width:100%; border:1px solid rgba(233,213,255,.55); border-radius:12px; overflow:hidden; background:transparent; }
  table{ width:100%; border-collapse:collapse; background:transparent; }
  thead th{ background:rgba(233,213,255,.85); color:#3b197b; text-align:left; padding:.85rem .9rem; font-weight:800; font-size:1.02rem; }
  tbody tr{ background:transparent!important; border-bottom:1px solid rgba(233,213,255,.55); }
  tbody tr:last-child{ border-bottom:none; }
  td{ padding:.9rem .9rem; font-size:1.03rem; color:#0f0f13; vertical-align:middle; }
  tbody tr:hover{ background:rgba(255,255,255,.24); backdrop-filter:blur(3px); -webkit-backdrop-filter:blur(3px); }

  .badgex{ display:inline-block; padding:.28rem .55rem; border-radius:999px; font-weight:700; font-size:.82rem; }
  .badge-code{ background:rgba(238,242,255,.85); color:#3730a3; }
  .badge-girls{ background:rgba(255,228,236,.85); color:#be185d; }
  .badge-boys{ background:rgba(224,236,255,.85); color:#1d4ed8; }
  .badge-coed{ background:rgba(233,255,236,.85); color:#15803d; }

  .text-right{ text-align:right; }
  .muted{ color:#000000; }

  .name-cell{ display:flex; align-items:center; gap:.65rem; }
  .avatar{ width:38px; height:38px; border-radius:999px; overflow:hidden; flex:0 0 38px; border:2px solid rgba(233,213,255,.85); box-shadow:0 2px 6px rgba(0,0,0,.08); cursor:zoom-in; }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .name-text{ font-weight:700; }

  /* Lightbox */
  .lb{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.75); z-index:1050; }
  .lb.open{ display:flex; }
  .lb-inner{ max-width:96vw; width:auto; text-align:center; }
  .lb-img{ max-width:48vw; max-height:48vh; object-fit:contain; border-radius:12px; user-select:none; -webkit-user-drag:none; cursor:zoom-out; box-shadow:0 10px 30px rgba(0,0,0,.5); }
  @media (max-width: 768px){ .lb-img{ max-width:88vw; max-height:60vh; } }
  .lb-caption{ margin-top:.6rem; }
  .lb-close{ position:absolute; top:14px; right:16px; background:#fff; border:none; border-radius:999px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 16px rgba(0,0,0,.3); cursor:pointer; font-size:1.1rem; }
  .lb-meta{ display:inline-flex; gap:.5rem; align-items:center; justify-content:center; color:#e5e7eb; font-weight:700; }
  .lb-badge{ display:inline-block; padding:.15rem .55rem; border-radius:999px; font-weight:800; font-size:.8rem; }
  .lb-badge.boys{  background:rgba(224,236,255,.85); color:#1d4ed8; }
  .lb-badge.girls{ background:rgba(255,228,236,.85); color:#be185d; }
  .lb-badge.coed{  background:rgba(233,255,236,.85); color:#15803d; }

  /* ===== Confirmation Modal ===== */
  .confirm-modal {
    position: fixed; inset: 0;
    display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.6); z-index: 2000;
  }
  .confirm-modal.active { display: flex; }
  .confirm-box {
    background: white; padding: 20px; border-radius: 12px; max-width: 320px; text-align: center;
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  }
  .confirm-box h4 { margin-bottom: 1rem; font-weight: 700; }
  .confirm-actions { display: flex; gap: .5rem; justify-content: center; }
  .confirm-btn {
    padding: .4rem .9rem; border-radius: 8px; font-weight: 600; border: none; cursor: pointer;
  }
  .confirm-yes { background: #b91c1c; color: white; }
  .confirm-no { background: #e5e7eb; }

  /* ===== Undo Toast ===== */
  .undo-toast {
    position: fixed; top: 20px; right: 20px;
    background: #8987ff; color: white; padding: .6rem 1rem;
    border-radius: 8px; font-weight: 600; display: none; z-index: 3000;
  }
  .undo-toast button {
    background: rgba(255,255,255,0.2); color: white; border: none;
    margin-left: 10px; padding: .2rem .6rem; border-radius: 4px; cursor: pointer;
  }
</style>

<div class="edge-to-edge">
  <div class="page-wrap">
    <h2 class="page-title">üè† Hostel List</h2>

    <div class="toolbar">
      <div><a href="{% url 'hostel:hostel_create' %}" class="btnx btn-primaryx">‚ûï Add Hostel</a></div>
      <form method="get" style="display:flex; gap:.6rem; align-items:center;">
        <input class="search-input" type="text" name="q" value="{{ request.GET.q }}" placeholder="Search by name, code, capacity, gender, warden name, contact‚Ä¶">
        <button class="btnx btn-outlinex" type="submit">Search</button>
      </form>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Code</th>
            <th>Capacity</th>
            <th>Gender</th>
            <th>Warden Name</th>
            <th>Warden Contact</th>
            <th class="text-right">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for hostel in object_list %}
          <tr data-id="{{ hostel.pk }}">
            <td>
              <div class="name-cell">
                <a class="avatar lb-open" href="#"
                   data-src="{% if hostel.warden_image %}{{ hostel.warden_image.url }}{% elif hostel.gender_policy == 'M' %}{% static 'images/default_boys.png' %}{% elif hostel.gender_policy == 'F' %}{% static 'images/default_girls.png' %}{% else %}{% static 'images/default_coed.png' %}{% endif %}"
                   data-name="{{ hostel.warden_name|default:'‚Äî' }}"
                   data-gender="{% if hostel.gender_policy == 'M' %}Boys{% elif hostel.gender_policy == 'F' %}Girls{% else %}Co-ed{% endif %}">
                  <img src="{% if hostel.warden_image %}{{ hostel.warden_image.url }}{% elif hostel.gender_policy == 'M' %}{% static 'images/default_boys.png' %}{% elif hostel.gender_policy == 'F' %}{% static 'images/default_girls.png' %}{% else %}{% static 'images/default_coed.png' %}{% endif %}" alt="Warden photo">
                </a>
                <span class="name-text">{{ hostel.name }}</span>
              </div>
            </td>
            <td><span class="badgex badge-code">{{ hostel.code }}</span></td>
            <td>{{ hostel.capacity }}</td>
            <td>
              {% if hostel.gender_policy == 'F' %}<span class="badgex badge-girls">Girls</span>
              {% elif hostel.gender_policy == 'M' %}<span class="badgex badge-boys">Boys</span>
              {% else %}<span class="badgex badge-coed">Co-ed</span>{% endif %}
            </td>
            <td>{{ hostel.warden_name|default:"‚Äì" }}</td>
            <td class="muted">{{ hostel.warden_contact|default:"‚Äì" }}</td>
            <td class="text-right">
              <a href="{% url 'hostel:hostel_update' hostel.pk %}" class="btnx btn-editx">‚úèÔ∏è Edit</a>
              <form action="{% url 'hostel:hostel_delete' hostel.pk %}" method="post" class="delete-form" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btnx btn-delex">üóëÔ∏è Delete</button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" style="text-align:center; padding:2rem 0;">No hostels found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="text-align:right; margin-top:.6rem; font-weight:600;">
      Showing {{ object_list|length }} item{{ object_list|length|pluralize }}
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="lb" id="lb">
  <button class="lb-close" id="lbClose" aria-label="Close">‚úï</button>
  <div class="lb-inner">
    <img id="lbImg" class="lb-img" alt="Warden image preview">
    <div id="lbCap" class="lb-caption"></div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="confirm-modal" id="confirmModal">
  <div class="confirm-box">
    <h4>Are you sure you want to delete?</h4>
    <div class="confirm-actions">
      <button class="confirm-btn confirm-yes">Yes</button>
      <button class="confirm-btn confirm-no">No</button>
    </div>
  </div>
</div>

<!-- Undo Toast -->
<div class="undo-toast" id="undoToast">
  Hostel deleted.
  <button id="undoBtn">Undo</button>
</div>

<script>
(function(){
  // Lightbox JS
  const lb = document.getElementById('lb');
  const lbImg = document.getElementById('lbImg');
  const lbCap = document.getElementById('lbCap');
  const lbClose = document.getElementById('lbClose');

  function openLB(src, name, gender){
    lbImg.src = src;
    const g = (gender || '').toLowerCase();
    const cls = g === 'boys' ? 'boys' : (g === 'girls' ? 'girls' : 'coed');
    lbCap.innerHTML = `<div class="lb-meta"><strong>${name || '‚Äî'}</strong><span class="lb-badge ${cls}">${gender || ''}</span></div>`;
    lb.classList.add('open');
    document.body.style.overflow = 'hidden';
  }
  function closeLB(){
    lb.classList.remove('open');
    lbImg.src = '';
    lbCap.innerHTML = '';
    document.body.style.overflow = '';
  }

  document.querySelectorAll('.lb-open').forEach(el=>{
    el.addEventListener('click', e=>{
      e.preventDefault();
      openLB(el.dataset.src, el.dataset.name, el.dataset.gender);
    });
  });
  lb.addEventListener('click', closeLB);
  lbClose.addEventListener('click', e=>{ e.stopPropagation(); closeLB(); });
  lbImg.addEventListener('click', e=>{ e.stopPropagation(); closeLB(); });
  document.addEventListener('keydown', e=>{
    if (e.key === 'Escape' && lb.classList.contains('open')) closeLB();
  });

  // Confirmation & Undo
  let targetForm = null;
  const confirmModal = document.getElementById('confirmModal');
  const undoToast = document.getElementById('undoToast');
  const undoBtn = document.getElementById('undoBtn');

  document.querySelectorAll('.delete-form').forEach(form=>{
    form.addEventListener('submit', function(e){
      e.preventDefault();
      targetForm = form;
      confirmModal.classList.add('active');
    });
  });

  confirmModal.querySelector('.confirm-yes').addEventListener('click', ()=>{
    confirmModal.classList.remove('active');
    // Show Undo toast before actually submitting
    undoToast.style.display = 'block';
    setTimeout(()=>{ undoToast.style.display = 'none'; targetForm.submit(); }, 5000); // 5s delay
  });
  confirmModal.querySelector('.confirm-no').addEventListener('click', ()=>{
    confirmModal.classList.remove('active');
    targetForm = null;
  });

  undoBtn.addEventListener('click', ()=>{
    undoToast.style.display = 'none';
    targetForm = null; // Cancel deletion
  });
})();
</script>
{% endblock %}