{% extends 'base.html' %}
{% load static %}

{% block title %}{% if view.object %}Edit Room{% else %}Add Room{% endif %} | Periyanachi ERP{% endblock %}

{% block content %}
<style>
  html, body { height: 100%; }
  body { background: transparent !important; }
  body::before {
    content:""; position: fixed; inset: 0;
    background: url("{% static 'images/bg-wave.png' %}") center/cover no-repeat fixed;
    z-index: -1;
  }

  :root{ --lav-strong:#7c3aed; --ink:#14121a; --muted:#3f3f46; }

  .form-shell{ max-width: 1100px; margin: 22px auto 32px; padding: 0 18px; }
  .page-title{ font-weight: 800; font-size: 2rem; color: var(--ink); display:flex; gap:.55rem; margin-bottom: 14px; }

  .form-pane{
    background: rgba(255,255,255,.70);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    border: 1px solid rgba(233,213,255,.55);
    border-radius: 14px;
    box-shadow: 0 10px 28px rgba(124,58,237,.12);
    padding: 22px;
  }

  .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap: 18px 22px; }
  @media (max-width: 840px){ .grid-2{ grid-template-columns: 1fr; } }

  .field label{
    display:block; font-weight:800; color:var(--muted); margin: 2px 0 6px 2px;
  }
  .form-control, .form-select{
    width:100%; background: transparent; border:none; border-bottom: 2px solid rgba(0,0,0,.18);
    padding: 10px 6px 8px 2px; font-size: 1.06rem; color: var(--ink); border-radius: 8px;
    outline: none; transition: border-color .15s, background .15s, box-shadow .15s;
  }
  .form-control:focus, .form-select:focus{
    border-bottom-color: var(--lav-strong);
    background: rgba(255,255,255,.25);
    box-shadow: 0 8px 24px rgba(124,58,237,.10);
  }
  .form-check-input{ transform: scale(1.1); margin-right:.4rem; }

  .table-wrap{ margin-top:16px; border:1px solid rgba(233,213,255,.55); border-radius:12px; overflow:hidden; }
  table{ width:100%; border-collapse:collapse; }
  thead th{ background:rgba(233,213,255,.85); color:#3b197b; text-align:left; padding:.7rem .9rem; font-weight:800; }
  tbody td{ padding:.6rem .9rem; vertical-align:middle; }
  tbody tr + tr{ border-top:1px solid rgba(233,213,255,.55); }

  .actions{ margin-top: 22px; display:flex; gap: 12px; justify-content:center; flex-wrap:wrap; }
  .btnx{ display:inline-block; padding:.9rem 1.6rem; border-radius:14px; font-weight:800; border:1px solid transparent; transition: all .18s ease; }
  .btn-primaryx{ background: linear-gradient(135deg,#a78bfa,#7c3aed); color:#fff; box-shadow: 0 10px 22px rgba(124,58,237,.22); }
  .btn-primaryx:hover{ background:#5b21b6; color:#fff; transform: translateY(-1px); }
  .btn-cancelx{ background:#fff; color:#6b7280; border:1px solid rgba(0,0,0,.12); }
  .btn-cancelx:hover{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
  .btn-addrow{ background:#fff; border:1px dashed #a78bfa; padding:.45rem .9rem; border-radius:999px; font-weight:800; }
  .btn-addrow:hover{ background:#ede9fe; }
  .btn-delrow{ background:#fff; border:1px solid #fca5a5; padding:.28rem .7rem; border-radius:9px; }
  .btn-delrow:hover{ background:#fee2e2; }
</style>

<div class="form-shell">
  <h2 class="page-title">
    {% if view.object %}‚úèÔ∏è Edit Room{% else %}üö™ Add Room{% endif %}
  </h2>

  <form method="post" class="form-pane" novalidate>
    {% csrf_token %}

    <div class="grid-2">
      <div class="field">
        <label>Hostel</label>
        {{ form.hostel }}
        {% if form.hostel.errors %}<div class="text-danger small">{{ form.hostel.errors }}</div>{% endif %}
      </div>

      <div class="field">
        <label>Room Number</label>
        {{ form.room_number }}
        {% if form.room_number.errors %}<div class="text-danger small">{{ form.room_number.errors }}</div>{% endif %}
      </div>

      <div class="field">
        <label>Floor</label>
        {{ form.floor }}
        {% if form.floor.errors %}<div class="text-danger small">{{ form.floor.errors }}</div>{% endif %}
      </div>
    </div>

    <div class="table-wrap">
      <div style="display:flex; justify-content:space-between; align-items:center; padding:.8rem .9rem;">
        <strong>Beds</strong>
        <button type="button" id="add-bed" class="btn-addrow">+ Add bed</button>
      </div>

      <div class="px-3">
        {{ formset.management_form }}  {# üî¥ REQUIRED #}
        <table>
          <thead>
            <tr>
              <th style="width:40%">Bed Number</th>
              <th style="width:20%">Available?</th>
              <th style="width:20%">Delete</th>
            </tr>
          </thead>
          <tbody id="beds-tbody">
            {% for f in formset.forms %}
              <tr class="bed-row">
                <td>
                  {% if f.id %}{{ f.id }}{% endif %}
                  {{ f.bed_number }}
                  {% if f.bed_number.errors %}<div class="text-danger small">{{ f.bed_number.errors }}</div>{% endif %}
                </td>
                <td>
                  <label class="form-check">
                    {{ f.is_available }} <span>Available</span>
                  </label>
                </td>
                <td>
                  {% if formset.can_delete %}
                    <label class="form-check">
                      {{ f.DELETE }} <span>Delete</span>
                    </label>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <!-- no beds yet -->
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="actions">
      <button type="submit" class="btnx btn-primaryx">üíæ Save</button>
      <a href="{% url 'hostel:room_list' %}" class="btnx btn-cancelx">Cancel</a>
    </div>
  </form>
</div>

<!-- Template for new bed row -->
<table style="display:none;">
  <tbody>
    <tr id="bed-empty-form" class="bed-row">
      <td>
        {{ formset.empty_form.id }}  {# include hidden id field placeholder #}
        {{ formset.empty_form.bed_number }}
      </td>
      <td>
        <label class="form-check">
          {{ formset.empty_form.is_available }} <span>Available</span>
        </label>
      </td>
      <td>
        {% if formset.can_delete %}
          <label class="form-check">
            {{ formset.empty_form.DELETE }} <span>Delete</span>
          </label>
        {% endif %}
      </td>
    </tr>
  </tbody>
</table>

<script>
  (function(){
    const addBtn = document.getElementById('add-bed');
    const tbody = document.getElementById('beds-tbody');

    // TOTAL_FORMS input
    const totalInput = document.querySelector('input[name="beds-TOTAL_FORMS"]');

    // the prototype row
    const emptyRow = document.getElementById('bed-empty-form');

    function addRow(){
      const index = parseInt(totalInput.value, 10);
      const clone = emptyRow.cloneNode(true);
      clone.removeAttribute('id');

      // replace __prefix__ in input names/ids with index
      clone.querySelectorAll('input,select,textarea').forEach(el=>{
        if (el.name) el.name = el.name.replace('__prefix__', index);
        if (el.id)   el.id   = el.id.replace('__prefix__', index);
      });

      tbody.appendChild(clone);
      totalInput.value = index + 1;
    }

    if (addBtn) addBtn.addEventListener('click', addRow);
  })();
</script>
{% endblock %}
