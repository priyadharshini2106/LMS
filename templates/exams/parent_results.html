{% extends 'base.html' %}
{% load static %}

{% block title %}Student Results{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Student Results</li>
{% endblock %}

{% block card_title %}My Child's Results{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-md-12">
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Child</label>
        <select name="child" class="form-select">
          {% for child in children %}
          <option value="{{ child.id }}" {% if child.id == selected_child %}selected{% endif %}>
            {{ child.full_name }} ({{ child.class_level.name }})
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Term</label>
        <select name="term" class="form-select">
          {% for term in terms %}
          <option value="{{ term.id }}" {% if term.id == selected_term %}selected{% endif %}>
            {{ term.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary">View Results</button>
      </div>
    </form>
  </div>
</div>

{% if results %}
<div class="row">
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Academic Performance</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="card bg-light mb-3">
              <div class="card-body text-center">
                <h6 class="card-title">Overall Average</h6>
                <div class="display-4 text-{% if selected_result.average >= 75 %}success{% elif selected_result.average >= 50 %}warning{% else %}danger{% endif %}">
                  {{ selected_result.average|floatformat:1 }}
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-light mb-3">
              <div class="card-body text-center">
                <h6 class="card-title">Class Rank</h6>
                <div class="display-4 text-info">
                  {{ selected_result.rank }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <table class="table table-striped">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Marks</th>
              <th>Grade</th>
              <th>Remarks</th>
            </tr>
          </thead>
          <tbody>
            {% for mark in marks %}
            <tr>
              <td>{{ mark.subject.name }}</td>
              <td>{{ mark.marks_obtained }} / {{ mark.max_marks }}</td>
              <td>
                <span class="badge bg-{% if mark.grade == 'A+' %}success
                                {% elif mark.grade == 'F' %}danger
                                {% else %}info{% endif %}">{{ mark.grade }}</span>
              </td>
              <td>{{ mark.remarks|default:"-" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">Performance Summary</h5>
      </div>
      <div class="card-body">
        <canvas id="performanceChart" height="250"></canvas>
        <div class="mt-3">
          <a href="{% url 'generate_report_card' selected_child selected_term %}" class="btn btn-primary w-100">
            <i class="bi bi-download"></i> Download Report Card
          </a>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Attendance</h5>
      </div>
      <div class="card-body">
        {% if absences %}
        <div class="alert alert-warning">
          <h6>Exam Absences:</h6>
          <ul>
            {% for absence in absences %}
            <li>
              {{ absence.exam_schedule.subject.name }} - {{ absence.exam_schedule.exam_date|date:"M d" }}
              {% if absence.approved %}
              <span class="badge bg-success">Approved</span>
              {% else %}
              <span class="badge bg-warning">Pending</span>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
        </div>
        {% else %}
        <p class="text-success">No exam absences recorded</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ðŸ‘‡ Embed grade data as JSON for JS -->
<script id="grade-data" type="application/json">
  {
    "grades": [
      {{ grade_counts.A|default:0 }},
      {{ grade_counts.B|default:0 }},
      {{ grade_counts.C|default:0 }},
      {{ grade_counts.D|default:0 }},
      {{ grade_counts.F|default:0 }}
    ]
  }
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/chart.min.js' %}"></script>
<script>
$(document).ready(function () {
  const chartDataElement = document.getElementById('grade-data');
  if (chartDataElement) {
    const dataObj = JSON.parse(chartDataElement.textContent);

    const ctx = document.getElementById('performanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['A Grades', 'B Grades', 'C Grades', 'D Grades', 'F Grades'],
        datasets: [{
          data: dataObj.grades,
          backgroundColor: [
            'rgba(40, 167, 69, 0.8)',
            'rgba(0, 123, 255, 0.8)',
            'rgba(255, 193, 7, 0.8)',
            'rgba(253, 126, 20, 0.8)',
            'rgba(220, 53, 69, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
});
</script>
{% endblock %}
