{% extends 'base.html' %}
{% load static %}

{% block title %}Marksheet â€“ {{ student.name }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'exams:exam_mark_list' %}">Exam Marks</a></li>
<li class="breadcrumb-item active">Marksheet</li>
{% endblock %}

{% block card_title %}Examination Marksheet{% endblock %}

{% block content %}
<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --line:#f3e8ee; --ok:#16a34a; --bad:#dc2626; --head:#831843; --brand:#be185d;
    --paper:#fff5f7; --border:#fbcfe8;
  }

  /* Paper container (stable for PDF) */
  .ms-paper{
    max-width: 820px;
    margin: 0 auto;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 14px;
    box-shadow: 0 8px 22px rgba(251, 207, 232, .3);
    padding: 18px 22px;
  }

  /* Header as grid: left info | right photo (no absolute positioning) */
  .ms-header-grid{
    display: grid;
    grid-template-columns: 1fr 140px;
    gap: 16px;
    align-items: center;
    border-bottom: 2px solid var(--border);
    padding-bottom: 12px;
    margin-bottom: 12px;
  }
  .ms-school{ font-size: 1.5rem; font-weight: 900; color: var(--head); letter-spacing: .3px; }
  .ms-subtitle{ font-size: .95rem; color: var(--head); font-weight: 700; margin-top: .2rem; }
  .ms-address{ font-size: .78rem; color: var(--muted); margin-top: .25rem; line-height: 1.3; }

  .photo-box{
    width: 140px; height: 140px; border: 2px solid var(--border); border-radius: 10px;
    background: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden;
  }
  .photo-box img{ width: 100%; height: 100%; object-fit: cover; }
  .photo-placeholder{ width: 70%; opacity: .35; }

  /* Student info grid */
  .ms-id{
    display: grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: .65rem;
    margin: 10px 0 6px;
    padding: 12px;
    background: rgba(255,255,255,.7);
    border: 1px solid rgba(251, 207, 232, .5);
    border-radius: 8px;
  }
  .ms-id .k{ font-size: .72rem; text-transform: uppercase; letter-spacing: .04em; color: var(--muted) }
  .ms-id .v{ font-weight: 900; color: var(--ink) }

  /* Marks table (fixed layout for PDF) */
  .ms-table{ width:100%; border-collapse:separate; border-spacing:0; margin:16px 0; table-layout: fixed; }
  .ms-table thead th{
    background: linear-gradient(to right, var(--head), var(--brand));
    color:#fff; font-size:.78rem; text-transform:uppercase; letter-spacing:.03em; padding:.55rem .6rem;
  }
  .ms-table tbody td{ padding:.55rem .6rem; border-top:1px solid rgba(251, 207, 232, .5); background: rgba(255,255,255,.8) }
  .ms-table tbody tr:nth-child(even) td{ background: rgba(255,255,255,.95) }
  .right{ text-align:right; white-space: nowrap }

  /* Summary */
  .summary{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.65rem; padding:12px; background: rgba(255,255,255,.7);
            border:1px solid rgba(251, 207, 232, .5); border-radius:8px }
  .sum-box{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:.5rem .75rem; font-weight:800 }

  /* Signatures */
  .signatures{ display:grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 53px; align-items: end; }
  .sig{
    border-top: 1px dashed var(--border); padding-top: 8px; text-align: center;
  }
  .sig img{ max-width: 220px; max-height: 70px; display: block; margin: 0 auto 4px; }
  .sig .name{ font-weight: 900; color: var(--ink); }
  .sig .label{ font-size: .82rem; color: var(--muted) }

  .footer-row{
    display:flex; justify-content: space-between; align-items: center; margin-top: 10px; color: var(--muted); font-size: .85rem;
  }

  /* Print */
  @media print{
    .toolbar, .breadcrumb, .navbar, .sidebar, .page-actions{ display:none !important; }
    .ms-paper{ max-width: 100%; box-shadow: none; border: none; padding: 0; background: #fff !important; }
    @page{ size: A4; margin: 14mm 12mm; }
  }
</style>

<div class="ms-paper">

  <!-- Header (grid: text | photo) -->
  <div class="ms-header-grid">
    <div>
      <div class="ms-school">{{ school_name }}</div>
      <div class="ms-address">{{ school_address }}</div>
      <div class="ms-subtitle">Examination Marksheet</div>
    </div>
    <div class="photo-box">
      {% if student.photo %}
        <img src="{{ student.photo.url }}" alt="{{ student.name }}'s photo">
      {% else %}
        <img class="photo-placeholder" src="{% static 'images/default_student.png' %}" alt="">
      {% endif %}
    </div>
  </div>

  <!-- Student Information -->
  <div class="ms-id">
    <div><div class="k">Student</div><div class="v">{{ student.name }}</div></div>
    <div><div class="k">Admission No</div><div class="v">{{ admission_no }}</div></div>
    <div><div class="k">Roll No</div><div class="v">{{ roll_no }}</div></div>
    <div><div class="k">Class</div><div class="v">{{ class_display }}</div></div>
    <div><div class="k">Academic Year</div><div class="v">{{ academic_year }}</div></div>
  </div>

  <!-- Marks Table -->
  <table class="ms-table">
    <colgroup>
      <col style="width: 42%">
      <col style="width: 18%">
      <col style="width: 18%">
      <col style="width: 12%">
      <col style="width: 10%">
    </colgroup>
    <thead>
      <tr>
        <th>Subject</th>
        <th class="right">Total Marks</th>
        <th class="right">Max Marks</th>
        <th class="right">%</th>
        <th class="right">Result</th>
      </tr>
    </thead>
    <tbody>
      {% if subject_rows %}
        {% for r in subject_rows %}
          <tr>
            <td>{{ r.name }}</td>
            <td class="right">{{ r.obtained }}</td>
            <td class="right">{{ r.max }}</td>
            <td class="right">{{ r.pct|floatformat:0 }}%</td>
            <td class="right">
              {% if r.passed %}
                <span>Pass</span>
              {% else %}
                <span>Fail</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="5" class="text-muted">No marks available.</td></tr>
      {% endif %}
    </tbody>
  </table>

  <!-- Summary -->
  <div class="summary">
    <div class="sum-box">Overall: {{ overall_obtained }} / {{ overall_max }}</div>
    <div class="sum-box">Percentage: {{ overall_pct|floatformat:0 }}%</div>
    <div class="sum-box">Result:
      {% if overall_pass %}Pass{% else %}Fail{% endif %}
      <span class="text-muted" style="font-weight:600; margin-left:.35rem;"></span>
    </div>
  </div>

  <!-- Signatures -->
  <div class="signatures">
    <div class="sig">
      {% if teacher_signature_url %}
        <img src="{{ teacher_signature_url }}" alt="Teacher Signature">
      {% endif %}
      <!-- <div class="name">{{ teacher_name }}</div> -->
      <div class="label">Class Teacher</div>
    </div>
    <div class="sig">
      {% if principal_signature_url %}
        <img src="{{ principal_signature_url }}" alt="Principal Signature">
      {% endif %}
      <!-- <div class="name">{{ principal_name }}</div> -->
      <div class="label">Principal</div>
    </div>
  </div>

  <div class="footer-row">
    <div>Date: {{ today|date:"d-m-Y" }}</div>
    <div class="no-print">
      <a href="?format=pdf" class="btn btn-sm btn-outline-primary">Download PDF</a>
      <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">Print</button>
    </div>
  </div>

</div>
{% endblock %}
