{% extends "base.html" %}
{% load custom_tags %}
{% block title %}Assign Fee to Student{% endblock %}

{% block content %}
<style>
  :root {
    --primary: #4361ee;
    --primary-dark: #3a56d4;
    --secondary: #6c757d;
    --success: #28a745;
    --danger: #e53935;
    --warning: #ffc107;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #212529;
    --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    --transition: all 0.3s ease;
  }

  .fee-assignment-card {
    background: white;
    border-radius: 16px;
    box-shadow: var(--card-shadow);
    border: none;
    overflow: hidden;
  }

  .card-header-custom {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 1.5rem;
    border-bottom: none;
  }

  .card-title {
    font-weight: 700;
    font-size: 1.5rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .card-body {
    padding: 2rem;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-label {
    font-weight: 600;
    color: var(--dark);
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .form-label i {
    color: var(--primary);
    width: 20px;
  }

  .form-control, .form-select {
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    font-size: 1rem;
    transition: var(--transition);
    background: white;
  }

  .form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
    outline: none;
  }

  .form-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234361ee' viewBox='0 0 16 16'%3E%3Cpath d='M8 12L2 6h12L8 12z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    background-size: 16px;
    padding-right: 40px;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }

  .amount-display {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 12px 16px;
    font-size: 1rem;
    font-weight: 600;
    color: var(--dark);
    min-height: 46px;
    display: flex;
    align-items: center;
  }

  .balance-card {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
  }

  .balance-label {
    font-size: 0.85rem;
    color: var(--secondary);
    font-weight: 600;
    margin-bottom: 5px;
  }

  .balance-amount {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--primary);
  }

  .form-check {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    margin: 0;
  }

  .form-check-input {
    width: 20px;
    height: 20px;
    margin: 0;
  }

  .form-check-label {
    font-weight: 600;
    color: var(--dark);
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-start;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 12px 24px;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    font-size: 1rem;
    transition: var(--transition);
    border: none;
    cursor: pointer;
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  .btn-success:hover {
    background: #218838;
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: var(--secondary);
    color: white;
  }

  .btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-2px);
  }

  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .form-actions {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
      justify-content: center;
    }
  }

  /* Animation for form elements */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .form-group {
    animation: fadeInUp 0.5s ease-out;
    animation-fill-mode: both;
  }

  .form-group:nth-child(1) { animation-delay: 0.1s; }
  .form-group:nth-child(2) { animation-delay: 0.2s; }
  .form-group:nth-child(3) { animation-delay: 0.3s; }
  .form-group:nth-child(4) { animation-delay: 0.4s; }
  .form-group:nth-child(5) { animation-delay: 0.5s; }
  .form-group:nth-child(6) { animation-delay: 0.6s; }
  .form-group:nth-child(7) { animation-delay: 0.7s; }
</style>

<div class="fee-assignment-card">
  <div class="card-header-custom">
    <h4 class="card-title">
      <i class="fas fa-money-bill-wave"></i> Assign Fee to Student
    </h4>
  </div>
  
  <div class="card-body">
    <form method="post" novalidate>
      {% csrf_token %}
      
      <div class="form-grid">
        <!-- Student Select -->
        <div class="form-group">
          <label for="{{ form.student.id_for_label }}" class="form-label">
            <i class="fas fa-user-graduate"></i> Student
          </label>
          {{ form.student|add_class:"form-select" }}
        </div>

        <!-- Fee Structure Select -->
        <div class="form-group">
          <label for="{{ form.fee_structure.id_for_label }}" class="form-label">
            <i class="fas fa-list-alt"></i> Fee Structure
          </label>
          {{ form.fee_structure|add_class:"form-select" }}
        </div>

        <!-- Original Amount -->
        <div class="form-group">
          <label for="{{ form.original_amount.id_for_label }}" class="form-label">
            <i class="fas fa-tag"></i> Original Amount
          </label>
          {{ form.original_amount|add_class:"form-control" }}
        </div>

        <!-- Discount Amount -->
        <div class="form-group">
          <label for="{{ form.discount_amount.id_for_label }}" class="form-label">
            <i class="fas fa-percent"></i> Discount
          </label>
          {{ form.discount_amount|add_class:"form-control" }}
        </div>

        <!-- Final Amount (readonly; auto) -->
        <div class="form-group">
          <label for="{{ form.final_amount.id_for_label }}" class="form-label">
            <i class="fas fa-calculator"></i> Final Amount
          </label>
          <div class="amount-display">
            {{ form.final_amount.value|default:"0.00" }}
          </div>
          {{ form.final_amount }}
        </div>

        <!-- Paid Amount -->
        <div class="form-group">
          <label for="{{ form.paid_amount.id_for_label }}" class="form-label">
            <i class="fas fa-credit-card"></i> Paid Amount
          </label>
          {{ form.paid_amount|add_class:"form-control" }}
        </div>

        <!-- Live Balance display -->
        <div class="form-group">
          <div class="balance-card">
            <div class="balance-label">Current Balance</div>
            <div id="balanceText" class="balance-amount">₹0.00</div>
          </div>
        </div>

        <!-- Fully Paid Checkbox -->
        <div class="form-group">
          <div class="form-check">
            {{ form.is_fully_paid|add_class:"form-check-input" }}
            <label for="{{ form.is_fully_paid.id_for_label }}" class="form-check-label">
              <i class="fas fa-check-circle"></i> Fully Paid?
            </label>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" class="btn btn-success">
          <i class="fas fa-save"></i> Save Assignment
        </button>
        <a href="{% url 'fees:student_fee_assignment_list' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Back to List
        </a>
      </div>
    </form>
  </div>
</div>

<script>
  (function () {
    const get = (i) => document.getElementById(i);
    const elOriginal = get('id_original_amount');
    const elDiscount = get('id_discount_amount');
    const elFinal = get('id_final_amount');
    const elPaid = get('id_paid_amount');
    const elFlag = get('id_is_fully_paid');
    const elBalance = get('balanceText');

    const toNum = (v) => {
      const n = parseFloat((v || '').toString().replace(/,/g, ''));
      return isNaN(n) ? 0 : n;
    };
    
    const money = (n) => '₹' + (toNum(n)).toFixed(2);

    function recalc() {
      const orig = toNum(elOriginal?.value);
      const disc = toNum(elDiscount?.value);
      let finalAmt = orig - disc;
      if (finalAmt < 0) finalAmt = 0;

      if (elFinal) elFinal.value = finalAmt.toFixed(2);

      const paid = toNum(elPaid?.value);
      let balance = finalAmt - paid;
      if (balance < 0) balance = 0;

      if (elBalance) {
        elBalance.textContent = money(balance);
        // Update color based on balance
        if (balance === 0) {
          elBalance.style.color = '#28a745'; // Green for zero balance
        } else {
          elBalance.style.color = '#e53935'; // Red for outstanding balance
        }
      }
      
      if (elFlag) elFlag.checked = finalAmt > 0 && paid >= finalAmt;
    }

    [elOriginal, elDiscount, elPaid].forEach(el => {
      if (el) {
        el.addEventListener('input', recalc);
        el.addEventListener('change', recalc);
      }
    });
    
    recalc(); // on load (good for edit page with initial values)
  })();
</script>
{% endblock %}